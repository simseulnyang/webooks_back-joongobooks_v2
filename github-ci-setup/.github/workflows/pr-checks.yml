name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-checks:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ì „ì²´ ížˆìŠ¤í† ë¦¬ë¥¼ ê°€ì ¸ì™€ì„œ ì»¤ë°‹ ë©”ì‹œì§€ í™•ì¸

    - name: ðŸ” Check PR title convention
      run: |
        PR_TITLE="${{ github.event.pull_request.title }}"
        echo "PR Title: $PR_TITLE"
        
        # Conventional Commits í˜•ì‹ ì²´í¬
        if echo "$PR_TITLE" | grep -qE '^(Feat|Fix|Docs|Style|Refactor|Test|Chore)(\(.+\))?: .+'; then
          echo "âœ… PR title follows Conventional Commits format"
        else
          echo "âŒ PR title does not follow Conventional Commits format"
          echo "Expected format: Type(scope): description"
          echo "Types: Feat, Fix, Docs, Style, Refactor, Test, Chore"
          exit 1
        fi

    - name: ðŸ“ Check commit messages
      run: |
        echo "Checking commit messages..."
        INVALID_COMMITS=0
        
        for commit in $(git log origin/${{ github.base_ref }}..${{ github.head_ref }} --format="%H"); do
          MESSAGE=$(git log -1 --format="%s" $commit)
          echo "Checking: $MESSAGE"
          
          if echo "$MESSAGE" | grep -qE '^(Feat|Fix|Docs|Style|Refactor|Test|Chore)(\(.+\))?: .+'; then
            echo "  âœ… Valid"
          else
            echo "  âŒ Invalid - does not follow Conventional Commits"
            INVALID_COMMITS=$((INVALID_COMMITS + 1))
          fi
        done
        
        if [ $INVALID_COMMITS -gt 0 ]; then
          echo ""
          echo "âŒ Found $INVALID_COMMITS invalid commit message(s)"
          echo "Please use Conventional Commits format:"
          echo "  Feat: add new feature"
          echo "  Fix: fix bug"
          echo "  Docs: update documentation"
          exit 1
        else
          echo "âœ… All commit messages are valid"
        fi

    - name: ðŸ“ Check PR size
      run: |
        CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...${{ github.head_ref }} | wc -l)
        ADDITIONS=$(git diff --shortstat origin/${{ github.base_ref }}...${{ github.head_ref }} | grep -oE '[0-9]+ insertion' | grep -oE '[0-9]+' || echo 0)
        DELETIONS=$(git diff --shortstat origin/${{ github.base_ref }}...${{ github.head_ref }} | grep -oE '[0-9]+ deletion' | grep -oE '[0-9]+' || echo 0)
        
        echo "ðŸ“Š PR Statistics:"
        echo "  Files changed: $CHANGED_FILES"
        echo "  Lines added: $ADDITIONS"
        echo "  Lines deleted: $DELETIONS"
        
        if [ $CHANGED_FILES -gt 50 ]; then
          echo "âš ï¸ Warning: This PR changes more than 50 files"
          echo "Consider splitting into smaller PRs for easier review"
        fi
        
        if [ $ADDITIONS -gt 1000 ]; then
          echo "âš ï¸ Warning: This PR adds more than 1000 lines"
          echo "Consider splitting into smaller PRs for easier review"
        fi

    - name: ðŸ” Check for TODO/FIXME comments
      run: |
        TODO_COUNT=$(grep -r "TODO\|FIXME" --include="*.py" --exclude-dir={venv,env,migrations,.git} . | wc -l || echo 0)
        
        if [ $TODO_COUNT -gt 0 ]; then
          echo "âš ï¸ Found $TODO_COUNT TODO/FIXME comments:"
          grep -rn "TODO\|FIXME" --include="*.py" --exclude-dir={venv,env,migrations,.git} . || true
          echo ""
          echo "Consider creating issues for these items"
        else
          echo "âœ… No TODO/FIXME comments found"
        fi

    - name: ðŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: ðŸ“¦ Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true

    - name: ðŸ—‚ï¸ Load cached venv
      id: cached-poetry-dependencies
      uses: actions/cache@v4
      with:
        path: .venv
        key: venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}

    - name: ðŸ“¦ Install linting tools
      run: |
        poetry install --no-interaction --only dev

    - name: ðŸŽ¨ Check import sorting with isort
      run: |
        poetry run isort --check-only --diff --profile black --line-length 120 --skip migrations --skip venv --skip env .
      continue-on-error: true

    - name: ðŸ“Š Lint summary
      if: always()
      run: |
        echo "## ðŸ“Š Lint Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… PR title check: Passed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Commit message check: Passed" >> $GITHUB_STEP_SUMMARY
        echo "- â„¹ï¸ Code style suggestions available above" >> $GITHUB_STEP_SUMMARY